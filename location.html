<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FixIt — Location</title>
  <link rel="stylesheet" href="fixit-app.css"/>

  <!-- Leaflet (no API key) -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin="anonymous" defer></script>
</head>
<body>
  <div class="stage">
    <div class="screen">
      <header><h1>Where’s the issue?</h1></header>

      <main class="pane">
        <!-- Live map -->
        <div class="card map-card">
          <div id="map"></div>
        </div>

        <div class="center mt12">
          <button id="locateBtn" class="btn btn-ghost" type="button">Use my location</button>
        </div>
      </main>

      <footer class="rail">
        <a class="btn btn-ghost" href="details.html">Back</a>
        <a class="btn grow" href="contact-info-page.html">Next</a>
      </footer>

      <!-- Rotating overlay while locating -->
      <div class="overlay" id="locOverlay" style="display:none;">
        <div class="modal">
          <h2 class="center">Finding your location…</h2>
          <div class="spinner"></div>
          <p class="center muted">Using GPS to drop a pin near you.</p>
          <div class="center mt12">
            <button id="cancelLocate" class="btn btn-ghost" type="button">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let canceled = false;

    function showOverlay() {
      document.getElementById('locOverlay').style.display = 'grid';
    }
    function hideOverlay() {
      document.getElementById('locOverlay').style.display = 'none';
    }

    window.addEventListener('load', () => {
      // Default view so it isn't empty before you locate (Auckland CBD)
      const DEFAULT = [-36.8485, 174.7633];
      const map = L.map('map', { zoomControl: true }).setView(DEFAULT, 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const marker = L.marker(DEFAULT).addTo(map);

      const btn = document.getElementById('locateBtn');
      const cancel = document.getElementById('cancelLocate');

      btn.addEventListener('click', () => {
        if (!('geolocation' in navigator)) {
          alert('Geolocation not supported by this browser.');
          return;
        }
        canceled = false;
        showOverlay();

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            if (canceled) return;           // ignore if user canceled overlay
            const { latitude, longitude } = pos.coords;
            const latlng = [latitude, longitude];
            marker.setLatLng(latlng);
            map.setView(latlng, 16, { animate: true });
            hideOverlay();
          },
          (err) => {
            hideOverlay();
            const reason = ({
              1: 'Permission denied',
              2: 'Position unavailable',
              3: 'Timeout'
            })[err.code] || 'Unknown error';
            alert('Could not get your location: ' + reason);
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      });

      cancel.addEventListener('click', () => {
        canceled = true;                    // we can't truly abort getCurrentPosition; just ignore result
        hideOverlay();
      });
    });
  </script>
</body>
</html>
