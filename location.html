<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FixIt — Location</title>

  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="missionx.css"/>

  <!-- Leaflet (no API key) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="anonymous"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="anonymous"
    defer
  ></script>

  <!-- Minimal overlay guarantees (keeps working even if styles.css is missing these) -->
  <style>
    /* Full-screen overlay above the map/content */
    #locOverlay{
      position:absolute; inset:0;
      display:grid; place-items:center;
      background:rgba(0,0,0,.18);
      z-index:1000;
    }
    #locOverlay[hidden]{ display:none; }

    /* While locating, make the map non-interactive */
    .stage.loading .leaflet-container{
      pointer-events:none;
    }
  </style>
</head>

<body>
  <!-- FixIt site header (logo + day/night toggle) -->
<header class="fx-header">
  <a href="home.html" aria-label="Go to home">
  <img src="images/Fixit logo.png" alt="FixIt" class="header-logo">
  </a>
  <div class="button-con" role="group" aria-label="Theme toggle">
    <!-- Sun icon -->
    <label for="cb1" aria-hidden="true">
      <svg id="dayIcon" viewBox="0 0 35 35" width="35" height="35" aria-hidden="true">
        <path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5 C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6 C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9 c0.414,0,0.789-0.168,1.06-0.439l-2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44 l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5 c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06 L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2 C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29 c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7 C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5 c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"/>
      </svg>
    </label>

    <input id="cb1" class="toggle" type="checkbox" role="switch" aria-label="Toggle dark mode">
    <label class="toggle-button" for="cb1" aria-hidden="true"></label>

    <!-- Moon icon -->
    <label for="cb1" aria-hidden="true">
      <svg id="nightIcon" viewBox="0 0 100 100" width="35" height="35" aria-hidden="true">
        <path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"/>
      </svg>
    </label>
  </div>
</header>

  
  <main id="main">
  <div class="stage">
    <div class="screen">
      <!-- <header><</header> -->

      <main class="pane">
        <h1>Where’s the <br>issue?</h1>
        <!-- Live map -->
        <div class="card map-card">
          <div id="map" aria-label="Map"></div>
        </div>

        <div class="center mt12">
          <button id="locateBtn" class="btn btn-ghost" type="button">
            Use my location
          </button>
        </div>
        <div class="card mt12 card-solid" style="padding:12px">
        <label for="coords">Coordinates</label>
      <input id="coords" class="input-solid" type="text" readonly placeholder="-36.8485, 174.7633">
       <p class="help muted">Updates when you move the pin, click the map, or press “Use my location”.</p>
      </div>

      </main>

      <footer class="rail">
        <a class="btn btn-ghost" href="details.html">Back</a>
        <a class="btn grow" href="contact-info-page.html">Next</a>
      </footer>

      <!-- Locating overlay -->
      <div class="overlay" id="locOverlay" hidden>
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="locTitle">
          <h2 id="locTitle" class="center">Finding your location…</h2>
          <div class="spinner" aria-hidden="true"></div>
          <p class="center muted">Using GPS to drop a pin near you.</p>
          <div class="center mt12">
            <button id="cancelLocate" class="btn btn-ghost" type="button">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (() => {
    // DOM refs
    const stage   = document.querySelector('.stage');
    const overlay = document.getElementById('locOverlay');
    const btn     = document.getElementById('locateBtn');
    const cancel  = document.getElementById('cancelLocate');

    // Map setup
    const DEFAULT = [-36.8485, 174.7633]; // Auckland CBD
    let canceled = false;
    let map, marker;

    const coordsInput = document.getElementById("coords");
    function updateCoords(latlng){
      if (!coordsInput) return;
      const obj = Array.isArray(latlng) ? {lat:latlng[0], lng:latlng[1]} : latlng;
      if (!obj) return;
      coordsInput.value = `${obj.lat.toFixed(5)}, ${obj.lng.toFixed(5)}`;
    }


    function initMap() {
      map = L.map('map', { zoomControl: true }).setView(DEFAULT, 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker(DEFAULT, {draggable:true}).addTo(map);
      // Show initial coords
      updateCoords(marker.getLatLng());
      // Click to move marker
      map.on("click", (e) => {
        marker.setLatLng(e.latlng);
        updateCoords(e.latlng);
      });
      // Drag end updates coords
      marker.on("moveend", (e) => {
        updateCoords(e.target.getLatLng());
      });
    }

    // Overlay helpers
    function showOverlay() {
      canceled = false;
      overlay.hidden = false;
      stage.classList.add('loading');
    }
    function hideOverlay() {
      overlay.hidden = true;
      stage.classList.remove('loading');
    }

    function handleLocateClick() {
      if (!('geolocation' in navigator)) {
        alert('Geolocation is not supported by this browser.');
        return;
      }
      showOverlay();

      navigator.geolocation.getCurrentPosition(
        ({ coords: { latitude, longitude } }) => {
          if (canceled) return; // user cancelled; ignore result
          const latlng = [latitude, longitude];
          marker.setLatLng(latlng);
          updateCoords({lat:latitude, lng:longitude});
          map.flyTo(latlng, 16, { duration: 0.7 });
          hideOverlay();
        },
        (err) => {
          hideOverlay();
          const reason = ({
            1: 'Permission denied',
            2: 'Position unavailable',
            3: 'Timeout'
          })[err.code] || 'Unknown error';
          alert('Could not get your location: ' + reason);
        },
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 10000 }
      );
    }

    function handleCancel() {
      canceled = true; // we can’t abort getCurrentPosition; we just ignore the result
      hideOverlay();
    }

    window.addEventListener('load', () => {
      initMap();
      btn.addEventListener('click', handleLocateClick);
      cancel.addEventListener('click', handleCancel);
    });
  })();
  </script>
  
  <!-- Theme toggle script -->
  <script>
  (function () {
  const KEY = 'fixit_theme';
  const body = document.body;
  const toggle = document.getElementById('cb1');
  const dayIcon = document.getElementById('dayIcon');
  const nightIcon = document.getElementById('nightIcon');

  function apply(mode){
    body.classList.remove('day-background','night-background');
    body.classList.add(mode === 'night' ? 'night-background' : 'day-background');
    if (toggle) toggle.checked = (mode === 'night');
    try { localStorage.setItem(KEY, mode); } catch {}
  }

  // Initial (saved > OS preference > default day)
  let saved = null;
  try { saved = localStorage.getItem(KEY); } catch {}
  if (!saved){
    const prefersDark = window.matchMedia &&
      window.matchMedia('(prefers-color-scheme: dark)').matches;
    saved = prefersDark ? 'night' : 'day';
  }
  apply(saved);

  // Events
  toggle?.addEventListener('change', () => apply(toggle.checked ? 'night' : 'day'));
  dayIcon?.addEventListener('click', () => apply('day'));
  nightIcon?.addEventListener('click', () => apply('night'));
})();
</script>

  <script src="app-m4.js" defer></script>
</body>
</html>